<!-- src/app/features/scanner/scanner.html -->
<div class="scan-wrap">
  <!-- Se já tem permissão -->
  <ng-container *ngIf="hasPermission(); else ask">
    <!-- Mostra o scanner (autostart) -->
    <ng-container *ngIf="showScanner(); else controls">
      <zxing-scanner
        #scannerEl
        [device]="currentDevice"
        [formats]="formats"
        [tryHarder]="true"
        [autostart]="true"
        (scanSuccess)="onScanSuccess($event)"
        (camerasFound)="onCamerasFound($event)"
        (permissionResponse)="onPermission($event)">
      </zxing-scanner>

      <!-- Moldura e dica -->
      <div class="overlay">
        <div class="box"></div>
        <div class="hint">Aponte para o QR</div>
      </div>

      <!-- Controles -->
      <div class="footer">
        <button mat-stroked-button (click)="switchCam()">Trocar câmera</button>
        <button mat-button (click)="stop()">Parar</button>
      </div>
    </ng-container>

    <!-- Se não estiver mostrando o scanner ainda -->
    <ng-template #controls>
      <div class="msg">
        <p>Toque para iniciar o scanner.</p>
        <button mat-flat-button color="primary" (click)="ensurePermissionAndStart()">
          Iniciar scanner
        </button>
      </div>
    </ng-template>
  </ng-container>

  <!-- Se ainda não tem permissão -->
  <ng-template #ask>
    <div class="msg">
      <p>Precisamos da sua autorização para usar a câmera.</p>
      <button mat-flat-button color="primary" (click)="ensurePermissionAndStart()">
        Permitir e iniciar
      </button>
      <!-- Instância oculta só pra disparar o fluxo de permissão em alguns browsers -->
      <zxing-scanner #scannerEl [autostart]="false" style="display:none"></zxing-scanner>
    </div>
  </ng-template>
</div>
